<div class="container">
    <h1>Analyse m√©dicale</h1>

    <!-- üìù Formulaire -->
    <form (ngSubmit)="submitAnalysis()" #formRef="ngForm" class="form-grid">
        <!-- Infos personnelles -->
        <label>Pr√©nom:
            <input type="text" [(ngModel)]="form.firstName" name="firstName" required />
        </label>

        <label>Nom:
            <input type="text" [(ngModel)]="form.lastName" name="lastName" required />
        </label>

        <label>Date de naissance:
            <input type="date" [(ngModel)]="form.birthDate" name="birthDate" required />
        </label>

        <label>Sexe:
            <select [(ngModel)]="form.gender" name="gender" required>
                <option value="" disabled selected>Choisir le sexe</option>
                <option value="Homme">Homme</option>
                <option value="Femme">Femme</option>
                <option value="Autre">Autre</option>
            </select>
        </label>

        <!-- Mesures -->
        <label>Taille (cm):
            <input list="heightList" [(ngModel)]="form.height" name="height" type="number" required />
            <datalist id="heightList">
                <option *ngFor="let h of heightOptions" [value]="h"></option>
            </datalist>
        </label>

        <label>Poids (kg):
            <input list="weightList" [(ngModel)]="form.weight" name="weight" type="number" required />
            <datalist id="weightList">
                <option *ngFor="let w of weightOptions" [value]="w"></option>
            </datalist>
        </label>

        <!-- Sympt√¥mes -->
        <label>Sympt√¥mes:
            <input list="symptomList" [(ngModel)]="currentSymptom" name="symptomTemp" type="text" placeholder="Tapez un sympt√¥me" />
            <datalist id="symptomList">
                <option *ngFor="let s of symptomSuggestions" [value]="s"></option>
            </datalist>
        </label>
        <button type="button" (click)="addSymptom()">Ajouter</button>

        <div *ngIf="form.symptomNames.length > 0" class="symptom-list">
            <strong>Sympt√¥mes s√©lectionn√©s :</strong>
            <ul>
                <li *ngFor="let s of form.symptomNames; let i = index">
                    {{ s }}
                    <button type="button" (click)="removeSymptom(i)">‚ùå</button>
                </li>
            </ul>
        </div>

        <!-- Marqueurs -->
        <div *ngFor="let result of form.biologicalResults; let i = index" class="marker-entry">
            <label>Marqueur:
                <input type="text" list="markerList"
                       [(ngModel)]="form.biologicalResults[i].markerName"
                       [attr.name]="'markerName-' + i" />
                <datalist id="markerList">
                    <option *ngFor="let m of markerSuggestions" [value]="m"></option>
                </datalist>
            </label>

            <label>Valeur:
                <input type="number"
                       [(ngModel)]="form.biologicalResults[i].value"
                       [attr.name]="'value-' + i" />
            </label>
        </div>
        <button type="button" (click)="addBiologicalResult()">Ajouter un marqueur</button>

        <!-- Boutons -->
        <div class="button-group">
            <button type="submit" [disabled]="loading">Analyser</button>
            <button type="button" (click)="resetForm()">R√©initialiser</button>
        </div>
    </form>

    <!-- Message de chargement -->
    <div *ngIf="loading" class="loading-message">
        üîÑ Analyse en cours, veuillez patienter...
    </div>

    <!-- R√©sum√© minimal -->
    <div *ngIf="response" class="summary-card">
        <p>‚úÖ Analyse termin√©e.</p>
        <button type="button" (click)="exportPdf()">üìÑ T√©l√©charger le rapport PDF</button>
    </div>

    <!-- Contenu PDF invisible -->
    <div id="pdf-content" style="display: none;">
        <h1 class="pdf-title">üß™ Rapport d'analyse m√©dicale</h1>

        <section>
            <h3>üë§ Informations Patient</h3>
            <p><strong>Nom :</strong> {{ form.lastName }} {{ form.firstName }}</p>
            <p><strong>Date de naissance :</strong> {{ form.birthDate }}</p>
            <p><strong>Sexe :</strong> {{ form.gender }}</p>
            <p><strong>Taille :</strong> {{ form.height }} cm</p>
            <p><strong>Poids :</strong> {{ form.weight }} kg</p>
        </section>

        <section *ngIf="form.symptomNames.length > 0">
            <h3>ü©∫ Sympt√¥mes</h3>
            <ul>
                <li *ngFor="let s of form.symptomNames">{{ s }}</li>
            </ul>
        </section>

        <section *ngIf="response?.biologicalResults?.length">
            <h3>üß¨ R√©sultats Biologiques</h3>
            <ul>
                <li *ngFor="let r of response.biologicalResults">
                    {{ r.markerName }} : {{ r.value }}
                </li>
            </ul>
        </section>

        <section *ngIf="response?.suggestions?.length">
            <h3>üìã Suggestions de Diagnostic</h3>
            <ul>
                <li *ngFor="let s of response.suggestions">
                    <strong>{{ s.diseaseName }}</strong><br />
                    Probabilit√© : {{ s.probability }}<br />
                    Description : {{ s.description }}
                </li>
            </ul>
        </section>

        <section class="signature-section">
            <p><strong>Signature du m√©decin :</strong></p>
            <div class="signature-box"></div>
            <p class="signature-note">Nom et cachet</p>
        </section>
    </div>
</div>
